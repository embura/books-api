// Generated by CoffeeScript 1.11.1
(function() {
  var DEFAULT_OPTIONS, _, cloneWithNonEnumerableProperties, createTestDoubleObject, createTestDoubleViaProxy, createTestDoublesForFunctionNames, createTestDoublesForPlainObject, createTestDoublesForPrototype, description, getAllPropertyNames, isConstructor, nameOf, tdFunction, withDefaults;

  _ = require('./util/lodash-wrap');

  cloneWithNonEnumerableProperties = require('./util/clone-with-non-enumerable-properties');

  isConstructor = require('./replace/is-constructor');

  tdFunction = require('./function');

  DEFAULT_OPTIONS = {
    excludeMethods: ['then']
  };

  module.exports = function(nameOrType, config) {
    return _.tap(createTestDoubleObject(nameOrType, withDefaults(config)), function(obj) {
      return obj.toString = function() {
        return description(nameOrType);
      };
    });
  };

  createTestDoubleObject = function(nameOrType, config) {
    if (isConstructor(nameOrType)) {
      return createTestDoublesForPrototype(nameOrType);
    } else if (_.isPlainObject(nameOrType)) {
      return createTestDoublesForPlainObject(nameOrType);
    } else if (_.isArray(nameOrType)) {
      return createTestDoublesForFunctionNames(nameOrType);
    } else {
      return createTestDoubleViaProxy(nameOrType, config);
    }
  };

  getAllPropertyNames = function(type) {
    var props;
    props = [];
    while (true) {
      props = _.union(props, Object.getOwnPropertyNames(type));
      if (!(type = Object.getPrototypeOf(type))) {
        break;
      }
    }
    return props;
  };

  createTestDoublesForPrototype = function(type) {
    return _.reduce(getAllPropertyNames(type.prototype), function(memo, name) {
      memo[name] = _.isFunction(type.prototype[name]) ? tdFunction((nameOf(type)) + "#" + name) : type.prototype[name];
      return memo;
    }, {});
  };

  createTestDoublesForPlainObject = function(obj) {
    return _.reduce(_.functions(obj), function(memo, functionName) {
      memo[functionName] = isConstructor(obj[functionName]) ? createTestDoublesForPrototype(obj[functionName]) : tdFunction("." + functionName);
      return memo;
    }, cloneWithNonEnumerableProperties(obj));
  };

  createTestDoublesForFunctionNames = function(names) {
    return _.reduce(names, function(memo, functionName) {
      memo[functionName] = tdFunction("." + functionName);
      return memo;
    }, {});
  };

  createTestDoubleViaProxy = function(name, config) {
    var obj, proxy;
    if (typeof Proxy === 'undefined') {
      throw new Error("The current runtime does not have Proxy support, which is what\ntestdouble.js depends on when a string name is passed to `td.object()`.\n\nMore details here:\n  https://github.com/testdouble/testdouble.js/blob/master/docs/4-creating-test-doubles.md#objectobjectname\n\nDid you mean `td.object(['" + name + "'])`?");
    }
    return proxy = new Proxy(obj = {}, {
      get: function(target, propKey, receiver) {
        if (!obj.hasOwnProperty(propKey) && !_.includes(config.excludeMethods, propKey)) {
          obj[propKey] = proxy[propKey] = tdFunction((nameOf(name)) + "#" + propKey);
        }
        return obj[propKey];
      }
    });
  };

  withDefaults = function(config) {
    return _.extend({}, DEFAULT_OPTIONS, config);
  };

  nameOf = function(nameOrType) {
    if (_.isFunction(nameOrType) && (nameOrType.name != null)) {
      return nameOrType.name;
    } else if (_.isString(nameOrType)) {
      return nameOrType;
    } else {
      return '';
    }
  };

  description = function(nameOrType) {
    var name;
    name = nameOf(nameOrType);
    return "[test double object" + (name ? " for \"" + name + "\"" : '') + "]";
  };

}).call(this);
